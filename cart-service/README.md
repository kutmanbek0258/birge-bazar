# Сервис Корзины (Cart Service)

Сервис `cart-service` отвечает за управление временными корзинами покупок пользователей в системе "Birge Bazar". Он позволяет пользователям добавлять, удалять, изменять количество товаров в корзине, а также просматривать ее содержимое.

## Основные возможности

-   Создание и получение корзины для аутентифицированных и анонимных пользователей.
-   Добавление товаров и их вариантов в корзину.
-   Обновление количества товара в корзине.
-   Удаление отдельных товаров из корзины.
-   Полная очистка корзины.
-   Хранение состояния корзины в реляционной базе данных.

## Архитектура

`cart-service` реализован как стандартный микросервис Spring Boot, взаимодействующий с PostgreSQL для персистентности данных. Он интегрирован в общую микросервисную инфраструктуру проекта.

## Технологический стек

-   **Java 17+**
-   **Spring Boot**
-   **Spring Data JPA** для взаимодействия с базой данных.
-   **PostgreSQL** в качестве основной базы данных.
-   **Liquibase** для управления миграциями схемы базы данных.
-   **Spring Security (OAuth2 Resource Server)** для защиты API.
-   **Spring Cloud** (Eureka Client, Config Client) для интеграции в микросервисную экосистему.
-   **Maven** для сборки проекта.

## Ключевые эндпоинты API

Все эндпоинты доступны по префиксу `/api/cart` и требуют валидного Bearer Token для аутентифицированных пользователей. Для анонимных пользователей требуется передавать `X-Session-ID` в заголовке.

---

### 1. Получить корзину

*   **GET** `/api/cart`
*   **Описание:** Возвращает содержимое корзины текущего пользователя (по `userId` из токена) или анонимной корзины (по `X-Session-ID`).
*   **Параметры запроса:** Нет (userId из токена, sessionId из заголовка `X-Session-ID`).
*   **Ответ (200 OK):** Объект корзины с позициями.

---

### 2. Добавить товар в корзину

*   **POST** `/api/cart/add`
*   **Описание:** Добавляет товар или его вариант в корзину. Если товар уже есть, увеличивает количество.
*   **Параметры запроса (Query Params):**
    *   `productId`: `Long` - ID товара.
    *   `productVariantId`: `Long` (опционально) - ID варианта товара.
    *   `quantity`: `int` - Количество для добавления.
    *   `priceAtAdd`: `BigDecimal` - Цена товара на момент добавления.
*   **Ответ (200 OK):** Обновленное состояние корзины.

---

### 3. Обновить количество товара в корзине

*   **PUT** `/api/cart/update-quantity`
*   **Описание:** Устанавливает новое количество для указанного товара в корзине. Если `newQuantity` <= 0, товар удаляется.
*   **Параметры запроса (Query Params):**
    *   `productId`: `Long` - ID товара.
    *   `productVariantId`: `Long` (опционально) - ID варианта товара.
    *   `newQuantity`: `int` - Новое количество.
*   **Ответ (200 OK):** Обновленное состояние корзины.

---

### 4. Удалить товар из корзины

*   **DELETE** `/api/cart/remove`
*   **Описание:** Полностью удаляет указанный товар из корзины.
*   **Параметры запроса (Query Params):**
    *   `productId`: `Long` - ID товара.
    *   `productVariantId`: `Long` (опционально) - ID варианта товара.
*   **Ответ (204 No Content):** Пустой ответ в случае успеха.

---

### 5. Очистить корзину

*   **DELETE** `/api/cart/clear`
*   **Описание:** Полностью удаляет все товары из корзины текущего пользователя/сессии.
*   **Ответ (204 No Content):** Пустой ответ в случае успеха.

## Запуск и разработка

### Необходимые компоненты
-   **JDK 17** или выше
-   **Apache Maven**
-   **Docker** и **Docker Compose** (рекомендуется для запуска инфраструктуры)

### 1. Настройка базы данных

`cart-service` использует PostgreSQL. В файлах `docker-compose.yml` уже определен сервис `postgres-cart`.

### 2. Запуск сервиса

#### 2.1. Запуск с помощью Docker Compose (рекомендуется)

Из корневой директории проекта (`/data/data/com.termux/files/home/birge-bazar/`):

```bash
# Запустить только cart-service и его базу данных
docker-compose up -d postgres-cart cart-service

# Или запустить весь проект
docker-compose up -d
```

#### 2.2. Локальный запуск (без Docker Compose для сервиса)

1.  Убедитесь, что у вас запущен экземпляр PostgreSQL с базой данных `cart_db` и учетными данными, указанными в `application.yml`.
2.  Убедитесь, что запущены `config-server`, `discovery-server` и `auth-service` (если они требуются для работы).
3.  Перейдите в директорию `cart-service`:
    ```bash
    cd /data/data/com.termux/files/home/birge-bazar/cart-service
    ```
4.  Соберите и запустите проект:
    ```bash
    mvn spring-boot:run
    ```